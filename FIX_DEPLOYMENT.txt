# WEB VIEWER FIX - DEPLOYMENT INSTRUCTIONS

## CRITICAL FIX APPLIED: Basketball API Timeout Issue (Dec 15, 2025)

### Problem
The `/oddsmagnet/api/basketball` endpoint was timing out with:
- `GET http://142.44.160.36:8000/oddsmagnet/api/basketball net::ERR_CONNECTION_TIMED_OUT`
- Multiple failed requests causing poor user experience
- No error handling for missing or slow file reads

### Root Cause
1. The basketball endpoint was using synchronous file I/O (blocking)
2. No timeout handling - hung indefinitely if file was being written
3. No proper error responses for missing/corrupted data
4. Basketball collector (`oddsmagnet_basketball_realtime.py`) may not be running

### Solution Applied
**File: `core/live_odds_viewer_clean.py`**
- ✅ Added async file reading with `aiofiles`
- ✅ Added 5-second timeout for file operations
- ✅ Proper error handling for:
  - Missing files (503 status)
  - Timeout errors (504 status)
  - JSON decode errors (503 status)
- ✅ Backward compatible with Python < 3.11

### Deployment Steps

1. **Pull Latest Changes on VPS:**
```bash
ssh ubuntu@142.44.160.36
cd /home/ubuntu/services/unified-odds
git pull origin main
```

2. **Restart the Web Viewer Service:**
```bash
sudo systemctl restart live-odds-viewer.service
sudo systemctl status live-odds-viewer.service
```

3. **Verify Basketball Collector is Running:**
```bash
# Check if basketball collector process is running
ps aux | grep basketball_realtime

# If not running, the main system should start it
sudo systemctl restart unified-odds.service
```

4. **Test the Endpoint:**
```bash
# Should return data or proper error (not timeout)
curl -v http://localhost:8000/oddsmagnet/api/basketball
```

### Expected Behavior After Fix
- **If basketball data exists:** Returns data within 5 seconds
- **If file doesn't exist:** Returns 503 with helpful message
- **If file is being written:** Returns 504 timeout error (not browser timeout)
- **If data corrupted:** Returns 503 with helpful message

No more browser-level connection timeouts!

---

## Original Problem - Web Viewer Not Running

### Step 1: SSH into VPS
```bash
ssh ubuntu@142.44.160.36
cd /home/ubuntu/services/unified-odds
```

### Step 2: Pull Latest Changes
```bash
git pull origin main
```

### Step 3: Run Fix Script
```bash
chmod +x deployment/fix_web_viewer.sh
./deployment/fix_web_viewer.sh
```

### Step 4: Verify Services Are Running
```bash
# Check web viewer status
sudo systemctl status live-odds-viewer.service

# Check if port 8000 is listening
ss -tlnp | grep :8000

# Test locally
curl http://localhost:8000/health
```

### Step 5: Test URLs
From your local machine:
- http://142.44.160.36/
- http://142.44.160.36/oddsmagnet
- http://142.44.160.36/health
- http://142.44.160.36/oddsmagnet/api/football/top10

## What Changed

1. **New Service File**: `deployment/live-odds-viewer.service`
   - Dedicated systemd service for the web viewer
   - Runs independently from data collection
   - Auto-restarts on failure

2. **Fix Script**: `deployment/fix_web_viewer.sh`
   - Installs and starts the web viewer service
   - Verifies it's working

## Service Management

```bash
# Start web viewer
sudo systemctl start live-odds-viewer.service

# Stop web viewer  
sudo systemctl stop live-odds-viewer.service

# Restart web viewer
sudo systemctl restart live-odds-viewer.service

# View logs
sudo journalctl -u live-odds-viewer.service -f

# Check status
sudo systemctl status live-odds-viewer.service
```

## Expected Result
After running the fix script:
- Port 8000 should be listening
- http://142.44.160.36/health should return JSON
- http://142.44.160.36/oddsmagnet should show the HTML viewer
- http://142.44.160.36/oddsmagnet/api/football/top10 should return encrypted data
