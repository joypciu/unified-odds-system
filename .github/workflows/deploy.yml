name: Deploy to VPS

on:
  push:
    branches:
      - main  # Trigger on push to main branch
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT }}
        script: |
          echo "üöÄ Starting deployment of unified odds system..."
          
          # Navigate to project directory
          cd /home/ubuntu/services/unified-odds
          
          # Pull latest changes from origin (joypciu/unified-odds-system)
          echo "üì• Pulling latest changes from GitHub..."
          git fetch origin
          git reset --hard origin/main
          git clean -fd
          
          # Activate virtual environment
          source venv/bin/activate
          
          # Install/update dependencies
          echo "üì¶ Installing dependencies..."
          pip install -r requirements.txt
          
          # Restart the service
          echo "üîÑ Restarting unified-odds service..."
          sudo systemctl restart unified-odds
          
          # Kill any process blocking port 8000 and restart UI service
          echo "üîÑ Restarting unified-odds-ui service..."
          sudo pkill -9 -f 'live_odds_viewer_clean.py' 2>/dev/null || true
          sleep 2
          sudo systemctl restart unified-odds-ui 2>/dev/null || echo "‚ö†Ô∏è  unified-odds-ui service not found (skipping)"
          
          # Wait a moment for services to start
          sleep 3
          
          # Check service status
          echo "‚úÖ Checking service status..."
          sudo systemctl status unified-odds --no-pager
          sudo systemctl status unified-odds-ui --no-pager 2>/dev/null || true
          
          echo "üéâ Deployment complete!"
          
    - name: Verify Deployment
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT }}
        script: |
          echo "üîç Verifying deployment..."
          
          # Check if main service is running
          if sudo systemctl is-active --quiet unified-odds; then
            echo "‚úÖ Unified odds service is running"
          else
            echo "‚ùå Unified odds service is not running!"
          fi
          
          # Check if UI service is running
          if sudo systemctl is-active --quiet unified-odds-ui; then
            echo "‚úÖ Unified odds UI service is running"
          else
            echo "‚ö†Ô∏è  Unified odds UI service is not running"
          fi
          
          # Show last 10 log lines from main service
          echo "üìã Recent logs from unified-odds:"
          sudo journalctl -u unified-odds -n 10 --no-pager
          
          # Exit with error if main service is not running
          if ! sudo systemctl is-active --quiet unified-odds; then
            echo "‚ùå Deployment failed - main service not running"
            sudo journalctl -u unified-odds -n 20 --no-pager
            exit 1
          fi
